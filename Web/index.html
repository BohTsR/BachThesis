<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 Live Data</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.7/gauge.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    h1, h2 { text-align: center; }
    #lastUpdate { text-align: center; font-size: 1rem; margin-top: -10px; margin-bottom: 10px; }
    .chart-container { display: flex; flex-wrap: wrap; justify-content: space-around; }
    .chart-container > div { width: 45%; margin: 20px 0; }
    canvas { width: 100%; height: 400px; }
    nav { text-align: center; margin: 20px 0; }
    nav a { margin: 0 10px; text-decoration: none; font-weight: bold; color: #007BFF; }
    nav a:hover { text-decoration: underline; }
    .gauge-container { text-align: center; margin-top: 40px; }
  </style>
</head>
<body>
  <h1>ESP32 Live Temperature & Humidity</h1>
  <p id="lastUpdate">Last update: loading...</p>
  <h2>Current Weather</h2>
  <p id="weatherBox">Loading...</p>
  <nav>
    <a href="index.html">Live Dashboard</a>
    <a href="history.html">View Historical Data</a>
    <a href="alertDetection.html">Alert Detection</a>
  </nav>
  <div class="chart-container">
    <div>
      <h2>Temperature (Today)</h2>
      <canvas id="temperatureTodayChart"></canvas>
    </div>
    <div>
      <h2>Humidity (Today)</h2>
      <canvas id="humidityTodayChart"></canvas>
    </div>
  </div>
  <div class="gauge-container">
    <h2>CO Gas Level</h2>
    <canvas id="coGauge" width="300" height="150"></canvas>
    <p id="coLevelText">CO Gas Level: N/A</p>
  </div>
  <script>
    let tempChart, humChart, coGauge, coGaugeText;

    const coGaugeOpts = {
      angle: 0,
      lineWidth: 0.3,
      radiusScale: 1,
      pointer: {
        length: 0.6,
        strokeWidth: 0.035,
        color: '#000000'
      },
      limitMax: false,
      limitMin: false,
      colorStart: '#6FADCF',
      colorStop: '#8FC0DA',
      strokeColor: '#E0E0E0',
      generateGradient: true,
      highDpiSupport: true,
      staticZones: [
        { strokeStyle: "#30B32D", min: 0, max: 35 },
        { strokeStyle: "#FFDD00", min: 36, max: 100 },
        { strokeStyle: "#F03E3E", min: 101, max: 300 }
      ],
      staticLabels: {
        font: "12px sans-serif",
        labels: [0, 35, 100, 300],
        color: "#000",
        fractionDigits: 0
      }
    };

    const coGaugeTarget = document.getElementById('coGauge');
    coGauge = new Gauge(coGaugeTarget).setOptions(coGaugeOpts);
    coGauge.maxValue = 300;
    coGauge.setMinValue(0);
    coGauge.animationSpeed = 32;
    coGauge.set(0);
    coGaugeText = document.getElementById("coLevelText");

    async function fetchTodayDataAndUpdateCharts() {
      try {
        const response = await fetch('SmartHome.json');
        if (!response.ok) return;
        const rawData = await response.json();

        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);

        const filtered = rawData.filter(entry => {
          const ts = entry.timestamp * 1000;
          return entry.device_id === 'SmartHome' && ts >= startOfDay.getTime() && ts <= now.getTime();
        });

        const temperature = filtered.map(entry => ({ x: entry.timestamp * 1000, y: parseFloat(entry.temperature.toFixed(1)) }));
        const humidity = filtered.map(entry => ({ x: entry.timestamp * 1000, y: parseFloat(entry.humidity.toFixed(1)) }));
        const latestCO = filtered.length ? filtered[filtered.length - 1].co_gas : 0;
        const latestTimestamp = filtered.length ? new Date(filtered[filtered.length - 1].timestamp * 1000) : null;

        if (latestTimestamp) {
          const formatted = `${latestTimestamp.getHours()}:${String(latestTimestamp.getMinutes()).padStart(2, '0')}.${latestTimestamp.getDate()}.${latestTimestamp.getFullYear()}`;
          document.getElementById("lastUpdate").textContent = `Last update: ${formatted}`;
        }

        const commonOptions = {
          elements: { line: { tension: 0.4 } },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
              min: startOfDay.getTime(),
              max: now.getTime(),
              title: { display: true, text: 'Time' }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Measurement' }
            }
          }
        };

        if (!tempChart) {
          const tempCtx = document.getElementById('temperatureTodayChart').getContext('2d');
          tempChart = new Chart(tempCtx, {
            type: 'line',
            data: { datasets: [{ label: 'Temperature', data: temperature, borderColor: 'rgba(255,99,132,1)', fill: false, pointRadius: 0 }] },
            options: commonOptions
          });
        } else {
          tempChart.options.scales.x.max = now.getTime();
          tempChart.data.datasets[0].data = temperature;
          tempChart.update();
        }

        if (!humChart) {
          const humCtx = document.getElementById('humidityTodayChart').getContext('2d');
          humChart = new Chart(humCtx, {
            type: 'line',
            data: { datasets: [{ label: 'Humidity', data: humidity, borderColor: 'rgba(54,162,235,1)', fill: false, pointRadius: 0 }] },
            options: commonOptions
          });
        } else {
          humChart.options.scales.x.max = now.getTime();
          humChart.data.datasets[0].data = humidity;
          humChart.update();
        }

        coGauge.set(latestCO);
        coGaugeText.textContent = `CO Gas Level: ${latestCO} ppm`;

      } catch (error) {
        console.error("Failed to fetch and update charts:", error);
      }
    }

    function fethDataFrompOpenWeather() {

        const lat = 50.126825;
        const lon = 14.464630;
        const appid = "e89b9eec0a2a2f4138996a47e5e03c4e";
        baseUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${appid}&units=metric`;

        fetch(baseUrl)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
            console.log('Weather data:', data);
            document.getElementById('weatherBox').textContent = `ðŸŒ¤ï¸ ${data.main.temp}Â°C in ${data.name}`;
            })
            .catch(error => {
                console.error('Fetch error:', error);
        });
    }

    fetchTodayDataAndUpdateCharts();
    setInterval(fetchTodayDataAndUpdateCharts, 1000);
    setInterval(fethDataFrompOpenWeather, 10000);
  </script>
</body>
</html>
